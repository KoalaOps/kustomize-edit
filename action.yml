name: 'Kustomize Edit'
description: 'Edit kustomize overlays - set images, labels, annotations, name/namespace, replicas, ConfigMap values'
author: 'KoalaOps'

branding:
  icon: 'edit'
  color: 'purple'

inputs:
  overlay_dir:
    description: 'Path to kustomize overlay directory'
    required: true
  debug:
    description: 'Enable debug output'
    required: false
    default: 'false'
  image:
    description: 'Image name (without tag)'
    required: false
  tag:
    description: 'Image tag'
    required: false
  version_label:
    description: 'Value for app.kubernetes.io/version label'
    required: false
  annotations:
    description: 'Annotations to add (key:value or key=value format, one per line)'
    required: false
  labels:
    description: 'Labels to add (key:value or key=value format, one per line)'
    required: false
  name_prefix:
    description: 'Name prefix to set'
    required: false
  name_suffix:
    description: 'Name suffix to set'
    required: false
  namespace:
    description: 'Namespace to set'
    required: false
  replicas:
    description: 'Replicas count to set (JSON format, e.g., [{"name":"deployment-name","count":3}])'
    required: false
  env_patches:
    description: 'Environment file patches (JSON format matching patch-env-files, e.g., {"container.env":{"SENTRY_RELEASE":"v1.2.3"}})'
    required: false

outputs:
  overlay_dir:
    description: 'Path to the edited overlay'
    value: ${{ inputs.overlay_dir }}
  kustomization_file:
    description: 'Path to kustomization.yaml'
    value: ${{ inputs.overlay_dir }}/kustomization.yaml

runs:
  using: 'composite'
  steps:
    - name: Check required tools
      shell: bash
      run: |
        set -euo pipefail
        echo "üîç Checking required tools..."

        # Check for kustomize
        if ! command -v kustomize >/dev/null 2>&1; then
          echo "::error::kustomize not found. Please install it first. See: https://kubectl.docs.kubernetes.io/installation/kustomize/"
          exit 1
        fi

        # Check for jq (needed for replicas)
        if [ -n "${{ inputs.replicas }}" ] && ! command -v jq >/dev/null 2>&1; then
          echo "::error::jq not found. Required for replicas input. Install with: apt-get install -y jq"
          exit 1
        fi

        # Check for yq (needed for version_label)
        if [ -n "${{ inputs.version_label }}" ] && ! command -v yq >/dev/null 2>&1; then
          echo "::warning::yq not found. Will be installed automatically if version_label is used."
        fi

        echo "‚úÖ Required tools available"
    
    - name: Validate overlay directory
      shell: bash
      run: |
        set -euo pipefail
        if [ ! -d "${{ inputs.overlay_dir }}" ]; then
          echo "::error::Overlay directory not found: ${{ inputs.overlay_dir }}"
          exit 1
        fi
        
        if [ ! -f "${{ inputs.overlay_dir }}/kustomization.yaml" ]; then
          echo "::error::No kustomization.yaml found in ${{ inputs.overlay_dir }}"
          exit 1
        fi
        
        echo "‚úÖ Found kustomization.yaml in: ${{ inputs.overlay_dir }}"
    
    - name: Set image and tag
      if: inputs.image != '' && inputs.tag != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üè∑Ô∏è Setting image: ${{ inputs.image }}:${{ inputs.tag }}"
        # Set the image with its tag
        # Format: [old-image-name=]new-image-name:new-tag
        # kustomize will match any existing image that starts with the image name
        kustomize edit set image "${{ inputs.image }}:${{ inputs.tag }}"
    
    - name: Set version label
      if: inputs.version_label != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üè∑Ô∏è Setting version label: ${{ inputs.version_label }}"

        # Check if yq is available
        if ! command -v yq >/dev/null 2>&1; then
          echo "::error::yq not found. Installing yq..."
          # Try to install yq based on the platform
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y yq
          elif command -v brew >/dev/null 2>&1; then
            brew install yq
          else
            # Fallback to downloading binary directly
            echo "Installing yq binary..."
            YQ_VERSION="v4.35.1"
            ARCH=$(uname -m)
            OS=$(uname -s | tr '[:upper:]' '[:lower:]')
            if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi
            curl -sL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_${OS}_${ARCH}" -o /tmp/yq
            chmod +x /tmp/yq
            sudo mv /tmp/yq /usr/local/bin/yq
          fi
        fi

        VERSION_LABEL="${{ inputs.version_label }}"
        export VERSION_LABEL

        # 1) Remove any old commonLabels version to avoid selector contamination
        yq -i 'del(.commonLabels."app.kubernetes.io/version")' kustomization.yaml 2>/dev/null || true

        # 2) Merge into an existing templates-only labels entry, or create one
        if yq -e '.labels[] | select(.includeTemplates == true and .includeSelectors == false)' kustomization.yaml >/dev/null 2>&1; then
          # Update existing templates-only entry
          yq -i '(.labels[] | select(.includeTemplates == true and .includeSelectors == false)).pairs."app.kubernetes.io/version" = env(VERSION_LABEL)' kustomization.yaml
        else
          # Add new templates-only entry
          yq -i '.labels += [{"pairs": {"app.kubernetes.io/version": env(VERSION_LABEL)}, "includeSelectors": false, "includeTemplates": true}]' kustomization.yaml
        fi

        echo "‚úÖ Version label set to: $VERSION_LABEL"
    
    - name: Add annotations
      if: inputs.annotations != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üìù Adding annotations..."
        echo "${{ inputs.annotations }}" | while IFS= read -r line; do
          # Strip trailing comments and trim whitespace
          line="${line%%#*}"
          line="$(echo "$line" | xargs)"
          [ -z "$line" ] && continue
          
          # Convert all = to : for kustomize format (support both formats)
          line="${line//=/:}"
          echo "  - $line"
          kustomize edit set annotation "$line"
        done
    
    - name: Add labels
      if: inputs.labels != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üè∑Ô∏è Adding labels..."
        echo "${{ inputs.labels }}" | while IFS= read -r line; do
          # Strip trailing comments and trim whitespace
          line="${line%%#*}"
          line="$(echo "$line" | xargs)"
          [ -z "$line" ] && continue
          
          # Convert all = to : for kustomize format (support both formats)
          line="${line//=/:}"
          echo "  - $line"
          kustomize edit set label "$line"
        done
    
    - name: Set name prefix
      if: inputs.name_prefix != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üìõ Setting name prefix: ${{ inputs.name_prefix }}"
        kustomize edit set nameprefix "${{ inputs.name_prefix }}"
    
    - name: Set name suffix
      if: inputs.name_suffix != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üìõ Setting name suffix: ${{ inputs.name_suffix }}"
        kustomize edit set namesuffix "${{ inputs.name_suffix }}"
    
    - name: Set namespace
      if: inputs.namespace != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üìÅ Setting namespace: ${{ inputs.namespace }}"
        kustomize edit set namespace "${{ inputs.namespace }}"
    
    - name: Set replicas
      if: inputs.replicas != ''
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üî¢ Setting replicas..."
        REPLICAS='${{ inputs.replicas }}'
        
        # Validate JSON
        if ! echo "$REPLICAS" | jq empty 2>/dev/null; then
          echo "::error::Invalid replicas JSON format"
          exit 1
        fi
        
        # Process each replica setting
        echo "$REPLICAS" | jq -c '.[]' | while read -r replica; do
          NAME=$(echo "$replica" | jq -r '.name // empty')
          COUNT=$(echo "$replica" | jq -r '.count // empty')
          if [ -z "$NAME" ] || [ -z "$COUNT" ]; then
            echo "::error::replicas entries must have {\"name\",\"count\"}"
            exit 1
          fi
          echo "  - $NAME: $COUNT replicas"
          kustomize edit set replicas "${NAME}=${COUNT}"
        done
    
    - name: Patch environment files
      if: inputs.env_patches != ''
      uses: KoalaOps/patch-env-files@v1
      with:
        path: ${{ inputs.overlay_dir }}
        patches: ${{ inputs.env_patches }}
    
    - name: Validate kustomization
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "‚úÖ Validating kustomization..."
        if ! kustomize build . > /dev/null 2>&1; then
          echo "::error::Kustomization validation failed"
          kustomize build . 2>&1 | head -20
          exit 1
        fi

        # Check that version label is not in selectors (would cause immutable field error)
        if [ -n "${{ inputs.version_label }}" ]; then
          echo "üîç Checking selectors don't contain version label..."
          MANIFESTS=$(kustomize build .)
          if echo "$MANIFESTS" | grep -A10 "kind: Deployment\|kind: StatefulSet\|kind: DaemonSet" | grep -B5 "selector:" | grep -q "app.kubernetes.io/version"; then
            echo "::error::Version label found in selector (immutable field). This would cause deployment to fail."
            echo "::error::The version label should only be in pod templates, not selectors."
            exit 1
          fi
        fi

        echo "‚úÖ Kustomization is valid"
    
    - name: Show debug output
      if: inputs.debug == 'true'
      shell: bash
      working-directory: ${{ inputs.overlay_dir }}
      run: |
        set -euo pipefail
        echo "üìã Final kustomization.yaml:"
        cat kustomization.yaml